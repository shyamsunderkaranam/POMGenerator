<!DOCTYPE html>
<html>
<head>
  <title>ATG Repository Viewer - Enhanced</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    
    .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    
    h2 { color: #333; margin-top: 0; }
    
    .input-section { margin-bottom: 20px; }
    textarea { width: 100%; height: 200px; padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px; }
    
    .button-group { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
    button:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .btn-primary { background: #0066cc; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-success { background: #28a745; color: white; }
    
    .stats { display: flex; gap: 20px; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px; flex-wrap: wrap; }
    .stat-item { display: flex; flex-direction: column; }
    .stat-label { font-size: 12px; color: #666; text-transform: uppercase; }
    .stat-value { font-size: 24px; font-weight: bold; color: #0066cc; }
    
    .section { margin: 30px 0; }
    h3 { color: #0066cc; border-bottom: 2px solid #0066cc; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    
    table { border-collapse: collapse; width: 100%; margin: 20px 0; background: white; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-family: 'Courier New', monospace; font-size: 13px; }
    th { background: #0066cc; color: white; font-weight: 600; position: sticky; top: 0; z-index: 10; }
    tr:nth-child(even) { background: #f8f9fa; }
    tr:hover { background: #e3f2fd; }
    
    .prop-name { font-weight: 600; background: #e3f2fd !important; color: #0066cc; white-space: nowrap; }
    
    .value-container { position: relative; }
    .value-display { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }
    
    .value-item { display: inline-flex; align-items: center; padding: 2px 6px; background: #e8f4f8; border-radius: 3px; max-width: 200px; }
    .value-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; }
    .value-text.expanded { white-space: normal; word-break: break-all; max-width: none; }
    .value-item:hover { background: #d0e8f2; }
    
    .repo-link { color: #0066cc; text-decoration: none; font-weight: 500; cursor: pointer; }
    .repo-link:hover { text-decoration: underline; }
    
    .expand-btn { margin-left: 4px; padding: 0 4px; font-size: 10px; cursor: pointer; background: #0066cc; color: white; border: none; border-radius: 2px; }
    .expand-btn:hover { background: #0052a3; }
    
    .action-btn { margin-left: 8px; padding: 2px 6px; font-size: 11px; cursor: pointer; border: none; border-radius: 3px; color: white; }
    .copy-btn { background: #28a745; }
    .copy-btn:hover { background: #218838; }
    .gen-btn { background: #fd7e14; }
    .gen-btn:hover { background: #e8590c; }
    
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #0066cc; padding-bottom: 10px; }
    .modal-title { font-size: 20px; font-weight: bold; color: #0066cc; }
    .close { font-size: 28px; font-weight: bold; cursor: pointer; color: #999; }
    .close:hover { color: #333; }
    
    .xml-output { background: #f8f9fa; padding: 15px; border-radius: 4px; border: 1px solid #ddd; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all; max-height: 400px; overflow-y: auto; }
    
    .breadcrumb { padding: 10px; background: #e3f2fd; border-radius: 4px; margin-bottom: 20px; font-size: 14px; }
    .breadcrumb a { color: #0066cc; text-decoration: none; }
    .breadcrumb a:hover { text-decoration: underline; }
    .breadcrumb span { margin: 0 5px; color: #666; }
    
    .filter-section { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 4px; }
    .filter-section input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
    
    .empty-state { text-align: center; padding: 40px; color: #999; }
    .empty-state svg { width: 64px; height: 64px; margin-bottom: 20px; opacity: 0.3; }
    
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #28a745; color: white; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 2000; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    .tooltip { position: relative; display: inline-block; }
    .tooltip .tooltiptext { visibility: hidden; background-color: #555; color: #fff; text-align: center; padding: 5px 10px; border-radius: 4px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; font-size: 11px; white-space: nowrap; }
    .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
  </style>
</head>
<body>

<div class="container">
  <h2>üîß ATG Repository Viewer</h2>
  
  <div class="input-section">
    <label for="xmlInput" style="font-weight: 600; margin-bottom: 8px; display: block;">Paste ATG Repository XML:</label>
    <textarea id="xmlInput" placeholder="Paste your <add-item> XML blocks here..."></textarea>
    
    <div class="button-group">
      <button class="btn-primary" onclick="parseAndRender()">üìä Parse & Display</button>
      <button class="btn-secondary" onclick="clearAll()">üóëÔ∏è Clear</button>
      <button class="btn-success" onclick="exportAllXML()">üíæ Export All XML</button>
    </div>
  </div>
  
  <div id="statsContainer"></div>
  <div id="breadcrumbContainer"></div>
  <div id="filterContainer"></div>
  <div id="tableContainer"></div>
</div>

<!-- Modal for XML Generation -->
<div id="xmlModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span class="modal-title">Generated XML</span>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div class="xml-output" id="xmlOutput"></div>
    <div style="margin-top: 15px;">
      <button class="btn-primary" onclick="copyModalXML()">üìã Copy to Clipboard</button>
    </div>
  </div>
</div>

<script>
  let globalData = {};
  let currentView = 'all';
  let currentDescriptor = null;
  
  const ITEMS_PER_LINE = 5;
  const MAX_CHARS_PER_ITEM = 50;

  function escapeHtml(str) {
    return (str || "").replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[m]));
  }

  function showNotification(message) {
    const notif = document.createElement('div');
    notif.className = 'notification';
    notif.textContent = message;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 3000);
  }

  function parseAndRender() {
    const xmlString = document.getElementById("xmlInput").value.trim();
    if (!xmlString) {
      alert("Please paste XML content.");
      return;
    }

    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(`<root>${xmlString}</root>`, "application/xml");
    const errorNode = xmlDoc.querySelector("parsererror");

    if (errorNode) {
      alert("Invalid XML format. Please check your input.");
      return;
    }

    const addItems = xmlDoc.getElementsByTagName("add-item");
    globalData = {};

    for (let item of addItems) {
      const desc = item.getAttribute("item-descriptor") || "unknown";
      const id = item.getAttribute("id") || "no-id";

      const props = {};
      for (let prop of item.getElementsByTagName("set-property")) {
        const name = prop.getAttribute("name");
        const value = prop.textContent.trim();
        if (name) props[name] = value;
      }
      globalData[desc] = globalData[desc] || [];
      globalData[desc].push({ id, ...props });
    }

    renderStats();
    renderView();
    showNotification('‚úì XML parsed successfully!');
  }

  function renderStats() {
    const descriptorCount = Object.keys(globalData).length;
    const totalItems = Object.values(globalData).reduce((sum, items) => sum + items.length, 0);
    
    const html = `
      <div class="stats">
        <div class="stat-item">
          <span class="stat-label">Descriptors</span>
          <span class="stat-value">${descriptorCount}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Total Items</span>
          <span class="stat-value">${totalItems}</span>
        </div>
      </div>
    `;
    document.getElementById('statsContainer').innerHTML = html;
  }

  function renderView() {
    if (currentView === 'all') {
      renderAllDescriptors();
    } else if (currentView === 'descriptor' && currentDescriptor) {
      renderDescriptorDetail(currentDescriptor);
    }
  }

  function renderAllDescriptors() {
    currentView = 'all';
    currentDescriptor = null;
    document.getElementById('breadcrumbContainer').innerHTML = '';
    document.getElementById('filterContainer').innerHTML = '';
    
    if (Object.keys(globalData).length === 0) {
      document.getElementById('tableContainer').innerHTML = `
        <div class="empty-state">
          <p style="font-size: 18px;">No data loaded. Paste XML and click "Parse & Display".</p>
        </div>
      `;
      return;
    }

    let html = '<div class="section">';
    
    for (const [desc, items] of Object.entries(globalData)) {
      html += `
        <h3>
          <span>üì¶ ${desc}</span>
          <span style="font-size: 14px; font-weight: normal;">${items.length} item${items.length !== 1 ? 's' : ''}</span>
        </h3>
        <table>
          <tr>
            <th>Item ID</th>
            <th>Properties</th>
            <th>Actions</th>
          </tr>
      `;
      
      for (const item of items) {
        const propCount = Object.keys(item).filter(k => k !== 'id').length;
        html += `
          <tr>
            <td><a class="repo-link" onclick="navigateToItem('${desc}', '${item.id}')">${item.id}</a></td>
            <td>${propCount} propert${propCount !== 1 ? 'ies' : 'y'}</td>
            <td>
              <button class="action-btn gen-btn" onclick="generateAddItem('${desc}', '${item.id}')">Generate XML</button>
            </td>
          </tr>
        `;
      }
      
      html += '</table>';
    }
    
    html += '</div>';
    document.getElementById('tableContainer').innerHTML = html;
  }

  function navigateToItem(descriptor, itemId) {
    currentView = 'descriptor';
    currentDescriptor = descriptor;
    renderDescriptorDetail(descriptor);
  }

  function renderDescriptorDetail(descriptor) {
    const breadcrumb = `
      <div class="breadcrumb">
        <a onclick="renderAllDescriptors()">üè† All Descriptors</a>
        <span>‚Ä∫</span>
        <span>${descriptor}</span>
      </div>
    `;
    document.getElementById('breadcrumbContainer').innerHTML = breadcrumb;

    const items = globalData[descriptor];
    if (!items || items.length === 0) {
      document.getElementById('tableContainer').innerHTML = '<p>No items found.</p>';
      return;
    }

    const propNames = new Set();
    items.forEach(item => Object.keys(item).forEach(k => { if (k !== "id") propNames.add(k); }));
    const sortedProps = Array.from(propNames).sort();

    let html = `
      <div class="section">
        <h3>
          <span>üì¶ ${descriptor}</span>
          <button class="btn-success" style="font-size: 12px; padding: 5px 10px;" onclick="generateAllItems('${descriptor}')">Generate All Items XML</button>
        </h3>
        <table>
          <tr>
            <th>Property</th>
            ${items.map(i => `<th>${i.id}</th>`).join("")}
          </tr>
    `;

    for (let prop of sortedProps) {
      html += `<tr><td class="prop-name">${prop}</td>`;
      
      for (let item of items) {
        const value = item[prop] || "";
        html += `<td>${renderValueCell(value, prop, descriptor)}</td>`;
      }
      
      html += `</tr>`;
    }

    html += '</table></div>';
    document.getElementById('tableContainer').innerHTML = html;
  }

  function renderValueCell(value, propName, descriptor) {
    if (!value) return '<span style="color: #999;">‚Äî</span>';
    
    const values = value.split(",").map(v => v.trim()).filter(v => v);
    
    let html = '<div class="value-display">';
    
    for (let i = 0; i < values.length; i++) {
      const val = values[i];
      const truncated = val.length > MAX_CHARS_PER_ITEM;
      const displayVal = truncated ? val.substring(0, MAX_CHARS_PER_ITEM) + '...' : val;
      const itemId = `val_${Math.random().toString(36).substr(2, 9)}`;
      
      html += `
        <div class="value-item">
          <span class="value-text" id="${itemId}" title="${escapeHtml(val)}" onclick="toggleExpand('${itemId}')">${escapeHtml(displayVal)}</span>
          ${truncated ? `<button class="expand-btn" onclick="toggleExpand('${itemId}')">...</button>` : ''}
        </div>
      `;
      
      if ((i + 1) % ITEMS_PER_LINE === 0 && i < values.length - 1) {
        html += '<div style="width: 100%; height: 4px;"></div>';
      }
    }
    
    html += `</div>`;
    html += `<button class="action-btn copy-btn" onclick="copyPrintItems('${propName}', '${escapeHtml(value).replace(/'/g, "\\'")}')">Copy print-item</button>`;
    
    return html;
  }

  function toggleExpand(elementId) {
    const elem = document.getElementById(elementId);
    if (!elem) return;
    
    const isExpanded = elem.classList.contains('expanded');
    const fullText = elem.getAttribute('title');
    
    if (isExpanded) {
      const truncated = fullText.length > MAX_CHARS_PER_ITEM;
      elem.textContent = truncated ? fullText.substring(0, MAX_CHARS_PER_ITEM) + '...' : fullText;
      elem.classList.remove('expanded');
    } else {
      elem.textContent = fullText;
      elem.classList.add('expanded');
    }
  }

  function copyPrintItems(propName, value) {
    const values = value.split(",").map(v => v.trim()).filter(v => v);
    const xmlSnippets = values.map(v => `<print-item item-descriptor="${propName}" id="${v}" />`).join("\n");
    
    navigator.clipboard.writeText(xmlSnippets).then(() => {
      showNotification('‚úì Print-item XML copied!');
    }).catch(() => {
      alert("Failed to copy to clipboard.");
    });
  }

  function generateAddItem(descriptor, itemId) {
    const items = globalData[descriptor];
    const item = items.find(i => i.id === itemId);
    
    if (!item) return;
    
    let xml = `<add-item item-descriptor="${descriptor}" id="${itemId}">\n`;
    
    for (const [key, value] of Object.entries(item)) {
      if (key !== 'id' && value) {
        xml += `  <set-property name="${key}"><![CDATA[${value}]]></set-property>\n`;
      }
    }
    
    xml += `</add-item>`;
    
    showModal(xml);
  }

  function generateAllItems(descriptor) {
    const items = globalData[descriptor];
    let xml = '';
    
    for (const item of items) {
      xml += `<add-item item-descriptor="${descriptor}" id="${item.id}">\n`;
      
      for (const [key, value] of Object.entries(item)) {
        if (key !== 'id' && value) {
          xml += `  <set-property name="${key}"><![CDATA[${value}]]></set-property>\n`;
        }
      }
      
      xml += `</add-item>\n\n`;
    }
    
    showModal(xml);
  }

  function exportAllXML() {
    if (Object.keys(globalData).length === 0) {
      alert("No data to export.");
      return;
    }
    
    let xml = '';
    
    for (const [descriptor, items] of Object.entries(globalData)) {
      for (const item of items) {
        xml += `<add-item item-descriptor="${descriptor}" id="${item.id}">\n`;
        
        for (const [key, value] of Object.entries(item)) {
          if (key !== 'id' && value) {
            xml += `  <set-property name="${key}"><![CDATA[${value}]]></set-property>\n`;
          }
        }
        
        xml += `</add-item>\n\n`;
      }
    }
    
    showModal(xml);
  }

  function showModal(xmlContent) {
    document.getElementById('xmlOutput').textContent = xmlContent;
    document.getElementById('xmlModal').style.display = 'block';
  }

  function closeModal() {
    document.getElementById('xmlModal').style.display = 'none';
  }

  function copyModalXML() {
    const text = document.getElementById('xmlOutput').textContent;
    navigator.clipboard.writeText(text).then(() => {
      showNotification('‚úì XML copied to clipboard!');
    }).catch(() => {
      alert("Failed to copy to clipboard.");
    });
  }

  function clearAll() {
    document.getElementById('xmlInput').value = '';
    globalData = {};
    document.getElementById('statsContainer').innerHTML = '';
    document.getElementById('breadcrumbContainer').innerHTML = '';
    document.getElementById('filterContainer').innerHTML = '';
    document.getElementById('tableContainer').innerHTML = '';
    showNotification('‚úì Cleared!');
  }

  window.onclick = function(event) {
    const modal = document.getElementById('xmlModal');
    if (event.target === modal) {
      closeModal();
    }
  }
</script>

</body>
</html>