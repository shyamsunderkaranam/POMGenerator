<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ATG XML Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    textarea {
      width: 100%;
      height: 150px;
      margin-bottom: 10px;
    }
    button {
      margin-bottom: 20px;
      padding: 6px 12px;
    }
    table {
      border-collapse: collapse;
      margin-bottom: 30px;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f4f4f4;
    }
    td {
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
    }
    td:hover {
      white-space: normal;
      overflow: visible;
      background: #ffffe0;
      z-index: 1;
    }
    .copy-btn {
      font-size: 10px;
      padding: 2px 4px;
      margin-left: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>ATG XML to Table</h2>
<textarea id="xmlInput" placeholder="Paste ATG repo XML here"></textarea><br>
<button onclick="parseXML()">Convert to Table</button>
<div id="output"></div>

<script>
function formatValues(val, itemsPerLine = 3) {
  if (!val) return "";
  const parts = val.split(",").map(v => v.trim());
  let lines = [];
  for (let i = 0; i < parts.length; i += itemsPerLine) {
    lines.push(parts.slice(i, i + itemsPerLine).join(", "));
  }
  return lines.join("<br>");
}

function copyPrintItemXML(header, value) {
  if (!value) return;
  const ids = value.split(",").map(v => v.trim()).filter(Boolean);
  const xmls = ids.map(id => `<print-item item-descriptor="${header}" id="${id}" />`);
  const finalText = xmls.join("\n");
  navigator.clipboard.writeText(finalText).then(() => {
    alert("Copied to clipboard:\n" + finalText);
  });
}

function parseXML() {
  const xmlText = document.getElementById("xmlInput").value.trim();
  if (!xmlText) {
    alert("Please paste XML content");
    return;
  }

  let parser = new DOMParser();
  let xmlDoc = parser.parseFromString(xmlText, "text/xml");
  let items = xmlDoc.getElementsByTagName("add-item");

  let dataMap = {}; // { itemDescriptor: [ {name: value} ] }

  for (let item of items) {
    let descriptor = item.getAttribute("item-descriptor");
    if (!dataMap[descriptor]) dataMap[descriptor] = [];

    let row = {};
    let props = item.getElementsByTagName("set-property");
    for (let prop of props) {
      let name = prop.getAttribute("name");
      let value = prop.textContent.trim();
      row[name] = value;
    }
    dataMap[descriptor].push(row);
  }

  let outputDiv = document.getElementById("output");
  outputDiv.innerHTML = "";

  for (let descriptor in dataMap) {
    let table = document.createElement("table");
    let thead = document.createElement("thead");
    let headerRow = document.createElement("tr");

    let keys = [...new Set(dataMap[descriptor].flatMap(obj => Object.keys(obj)))];
    headerRow.appendChild(document.createElement("th")).textContent = "Property";

    for (let i = 0; i < dataMap[descriptor].length; i++) {
      let th = document.createElement("th");
      th.textContent = `${descriptor} ${i + 1}`;
      headerRow.appendChild(th);
    }

    thead.appendChild(headerRow);
    table.appendChild(thead);

    let tbody = document.createElement("tbody");
    for (let key of keys) {
      let tr = document.createElement("tr");
      let th = document.createElement("th");
      th.textContent = key;
      tr.appendChild(th);

      for (let row of dataMap[descriptor]) {
        let td = document.createElement("td");
        let val = row[key] || "";
        td.innerHTML = formatValues(val, 3);

        // Small copy button
        let btn = document.createElement("button");
        btn.textContent = "â§‰";
        btn.className = "copy-btn";
        btn.onclick = () => copyPrintItemXML(key, val);

        td.appendChild(btn);
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    outputDiv.appendChild(table);
  }
}
</script>

</body>
</html>
